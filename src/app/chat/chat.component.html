<ob-column-layout class="h100" [left]="isRegistered()" [right]="isRegistered()">
	<div column-left-content class="h100">
		<mat-card class="history-card">
			<mat-card-header class="flex-row aic jcsb">
				<mat-card-title class="mt16">{{ "chat_history" | translate }}</mat-card-title>
				<button mat-icon-button [obButton]="'primary'" (click)="newChat()">
					<mat-icon svgIcon="speech-bubble"></mat-icon>
				</button>
			</mat-card-header>
			<mat-card-content>
				<zco-chat-history
					*ngIf="isRegistered()"
					[titles]="conversationTitles"
					(conversationSelected)="selectConversation($event)"
					(conversationDeleted)="deleteConversation($event)"
				></zco-chat-history>
			</mat-card-content>
		</mat-card>
	</div>

	<div column-main-content class="chat-container">
		<div class="logo" *ngIf="messages.length <= 0">
			<img src="./assets/images/copilot_logo.png" alt="copilot-logo" />
		</div>
		<div class="message-container">
			<div
				*ngFor="let message of messages; let last = last; let i = index"
				class="message"
				[class.retrieving]="message.isRetrieving"
				[class.validating]="message.isValidating"
				[class.routing]="message.isRouting"
				[class.agent]="message.isAgent"
				[class.tool]="message.isToolUse"
				[class.assistant]="message.source !== ChatMessageSource.USER"
				[class.user]="message.source === ChatMessageSource.USER"
			>
				<div class="flex-row" [ngClass]="message.source === ChatMessageSource.USER ? 'my-message' : 'ia-message'">
					<img
						[hidden]="message.source === ChatMessageSource.USER"
						[ngClass]="last && !message.isCompleted ? 'blink' : ''"
						class="mr16 ia-avatar"
						src="./assets/images/copilot_logo.png"
						alt="copilot-logo"
					/>
					<zco-chat-message [message]="message" [previousMessage]="i > 0 ? messages[i - 1] : null" (feedback)="sendFeedback($event)"></zco-chat-message>
				</div>
			</div>
		</div>
		<zco-dynamic-form
			class="form-container"
			*ngIf="activeForm"
			[def]="activeForm.def"
			[form]="activeForm.group"
			(submitted)="onFormSubmit()"
			(closeForm)="onCloseForm()"
		></zco-dynamic-form>
		<zco-question-suggestion *ngIf="messages.length <= 0"></zco-question-suggestion>
		<zco-action-suggestions
			*ngIf="isRegistered() && !activeForm"
			[suggestions]="defaultSuggestions.concat(specificSuggestions || [])"
			(actionSelected)="handleSuggestionAction($event)"
		>
		</zco-action-suggestions>
		<form *ngIf="!activeForm" class="question-container" ngForm>
			<ut-autocomplete-input
				*ngIf="!displayTextArea"
				class="mr8"
				[required]="false"
				[i18nLabel]="'enter.message'"
				[optionLabelFn]="searchOptionLabelFn"
				[inputLabelFn]="searchOptionLabelFn"
				[optionService]="getOptionService()"
				[minLength]="0"
				[formControl]="searchCtrl"
				(optionSelected)="handleOptionSelected($event)"
				(inputChange)="isCommandMode = $event.startsWith('/')"
			/>

			<button type="submit" mat-icon-button [obButton]="'primary'" (click)="sendToLLM()" [disabled]="!searchCtrl.value">
				<mat-icon svgIcon="paper-plane"></mat-icon>
			</button>

			<button type="button" mat-icon-button (click)="clearSearch()" [obButton]="'secondary'">
				<mat-icon svgIcon="trash"></mat-icon>
			</button>

			<button *ngIf="isRegistered()" type="button" mat-icon-button (click)="uploadDoc()" [obButton]="'secondary'">
				<mat-icon svgIcon="upload"></mat-icon>
			</button>
		</form>
	</div>

	<div column-right-content class="h100">
		<mat-card class="configuration-card">
			<mat-card-header>
				<mat-card-title class="mt16">{{ "parameters.title" | translate }}</mat-card-title>
			</mat-card-header>
			<mat-card-content>
				<zco-chat-configuration-edit [formControl]="chatConfigCtrl"></zco-chat-configuration-edit>
			</mat-card-content>
		</mat-card>
	</div>
</ob-column-layout>

<ng-template #userNotRegisteredTriesToChatDialog>
	<h2 mat-dialog-title>{{ "copilot.register.info.title" | translate }}</h2>
	<div mat-dialog-content>
		<p>{{ "copilot.register.info.text.1" | translate }}</p>
		<p>{{ "copilot.register.info.text.2" | translate }}</p>
		<p>
			{{ "copilot.register.info.text.3" | translate }}
			<mat-icon svgIcon="user-pen" style="color: blue !important" />
		</p>
	</div>
</ng-template>

<ng-template #userPendingTriesToChatDialog>
	<h2 mat-dialog-title>{{ "copilot.pending.info.title" | translate }}</h2>
	<div mat-dialog-content>
		<p>{{ "copilot.pending.info.text.1" | translate }}</p>
		<p>{{ "copilot.pending.info.text.2" | translate }}</p>
	</div>
</ng-template>
