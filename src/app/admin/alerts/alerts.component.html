<div class="alerts-root">
	<!-- Formulaire de création -->
	<mat-card class="ob-card form-card">
		<mat-card-title>{{ "admin.alerts.create.title" | translate }}</mat-card-title>
		<mat-card-content>
			<form [formGroup]="form" class="alerts-form">
				<!-- Ligne 1 : niveau, date, heure -->
				<div class="top-row">
					<mat-form-field appearance="outline">
						<mat-label>{{ "admin.alerts.level" | translate }}</mat-label>
						<mat-select formControlName="level">
							<mat-option *ngFor="let l of levels" [value]="l">{{ l }}</mat-option>
						</mat-select>
					</mat-form-field>

					<mat-form-field appearance="outline">
						<mat-label>{{ "admin.alerts.date" | translate }}</mat-label>
						<input matInput [matDatepicker]="picker" formControlName="date" />
						<mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
						<mat-datepicker #picker></mat-datepicker>
					</mat-form-field>

					<mat-form-field appearance="outline">
						<mat-label>{{ "admin.alerts.time" | translate }}</mat-label>
						<input matInput placeholder="HH:mm" formControlName="time" />
						<mat-hint *ngIf="form.get('time')?.invalid && form.get('time')?.touched">HH:mm</mat-hint>
					</mat-form-field>
				</div>

				<!-- Indication texte par défaut (affichée si tout est vide) -->
				<div class="default-hint" *ngIf="allTextEmpty()">
					{{ "admin.alerts.defaultText.hint" | translate }}
				</div>

				<!-- Textes optionnels en accordéon -->
				<mat-accordion multi="false" class="texts-accordion">
					<mat-expansion-panel [expanded]="!allTextEmpty()">
						<mat-expansion-panel-header>
							<mat-panel-title>{{ "admin.alerts.customTexts.title" | translate }}</mat-panel-title>
							<mat-panel-description>{{ "admin.alerts.customTexts.desc" | translate }}</mat-panel-description>
						</mat-expansion-panel-header>

						<div class="texts-col">
							<mat-form-field appearance="outline">
								<mat-label>{{ "admin.alerts.textFr" | translate }}</mat-label>
								<textarea matInput rows="2" formControlName="textFr"></textarea>
							</mat-form-field>

							<mat-form-field appearance="outline">
								<mat-label>{{ "admin.alerts.textDe" | translate }}</mat-label>
								<textarea matInput rows="2" formControlName="textDe"></textarea>
							</mat-form-field>

							<mat-form-field appearance="outline">
								<mat-label>{{ "admin.alerts.textIt" | translate }}</mat-label>
								<textarea matInput rows="2" formControlName="textIt"></textarea>
							</mat-form-field>
						</div>
					</mat-expansion-panel>
				</mat-accordion>

				<div class="actions">
					<button mat-button [obButton]="'primary'" [disabled]="form.invalid" (click)="create()">
						{{ "admin.alerts.create.cta" | translate }}
					</button>
				</div>
			</form>
		</mat-card-content>
	</mat-card>

	<!-- Tables -->
	<div class="tables">
		<!-- Actives -->
		<mat-card class="ob-card table-card">
			<mat-card-title>{{ "admin.alerts.active" | translate }}</mat-card-title>
			<mat-card-content>
				<table mat-table [dataSource]="activeData" matSort #activeSort="matSort" class="ob-table">
					<!-- LEVEL -->
					<ng-container matColumnDef="level">
						<th mat-header-cell *matHeaderCellDef class="col-level">
							{{ "admin.alerts.level" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="level-cell">
							<mat-chip-set class="level-chip">
								<mat-chip [color]="r.level === 'WARNING' ? 'warn' : undefined" selected>
									{{ r.level }}
								</mat-chip>
							</mat-chip-set>
						</td>
					</ng-container>

					<!-- MESSAGE -->
					<ng-container matColumnDef="message">
						<th mat-header-cell *matHeaderCellDef class="col-message">
							{{ "admin.alerts.texts" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="message-cell">
							<span class="message-text">
								{{ currentText(r) | translate }}
							</span>
						</td>
					</ng-container>

					<!-- EXPIRES -->
					<ng-container matColumnDef="expires">
						<th mat-header-cell *matHeaderCellDef class="col-expires">
							{{ "admin.alerts.expires" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="expires-cell">
							{{ r.expiresAt ? (r.expiresAt | date: "yyyy-MM-dd HH:mm") : ("admin.alerts.noexpiry" | translate) }}
						</td>
					</ng-container>

					<!-- ACTIONS -->
					<ng-container matColumnDef="actions">
						<th mat-header-cell *matHeaderCellDef class="col-actions"></th>
						<td mat-cell *matCellDef="let r" class="row-actions">
							<button mat-icon-button [obButton]="'secondary'" (click)="delete(r)">
								<mat-icon [svgIcon]="'trash'" [matTooltip]="'admin.alerts.delete' | translate"></mat-icon>
							</button>
						</td>
					</ng-container>

					<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
					<tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
				</table>
				<mat-paginator #activePaginator [pageSizeOptions]="[5, 10, 25]" [pageSize]="5"></mat-paginator>
			</mat-card-content>
		</mat-card>

		<!-- Expirées -->
		<mat-card class="ob-card table-card">
			<mat-card-title>{{ "admin.alerts.expired" | translate }}</mat-card-title>
			<mat-card-content>
				<table mat-table [dataSource]="expiredData" matSort #expiredSort="matSort" class="ob-table">
					<!-- LEVEL -->
					<ng-container matColumnDef="level">
						<th mat-header-cell *matHeaderCellDef class="col-level">
							{{ "admin.alerts.level" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="level-cell">
							<mat-chip-set class="level-chip">
								<mat-chip [color]="r.level === 'WARNING' ? 'warn' : undefined" selected>
									{{ r.level }}
								</mat-chip>
							</mat-chip-set>
						</td>
					</ng-container>

					<!-- MESSAGE -->
					<ng-container matColumnDef="message">
						<th mat-header-cell *matHeaderCellDef class="col-message">
							{{ "admin.alerts.texts" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="message-cell">
							<span class="message-text">
								{{ currentText(r) | translate }}
							</span>
						</td>
					</ng-container>

					<!-- EXPIRES -->
					<ng-container matColumnDef="expires">
						<th mat-header-cell *matHeaderCellDef class="col-expires">
							{{ "admin.alerts.expires" | translate }}
						</th>
						<td mat-cell *matCellDef="let r" class="expires-cell">
							{{ r.expiresAt ? (r.expiresAt | date: "yyyy-MM-dd HH:mm") : ("admin.alerts.noexpiry" | translate) }}
						</td>
					</ng-container>

					<!-- ACTIONS -->
					<ng-container matColumnDef="actions">
						<th mat-header-cell *matHeaderCellDef class="col-actions"></th>
						<td mat-cell *matCellDef="let r" class="row-actions">
							<button mat-icon-button [obButton]="'primary'" (click)="reactivate(r)">
								<mat-icon [svgIcon]="'refresh'" [matTooltip]="'admin.alerts.reactivate' | translate"></mat-icon>
							</button>
							<button mat-icon-button [obButton]="'secondary'" (click)="delete(r)">
								<mat-icon [svgIcon]="'trash'" [matTooltip]="'admin.alerts.delete' | translate"></mat-icon>
							</button>
						</td>
					</ng-container>

					<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
					<tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
				</table>
				<mat-paginator #expiredPaginator [pageSizeOptions]="[5, 10, 25]" [pageSize]="5"></mat-paginator>
			</mat-card-content>
		</mat-card>
	</div>
</div>
